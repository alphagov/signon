<h1>User accounts</h1>

<div class="well">

  <div class="row-fluid">
    <div class="span7">
      <div>
        <%= search_form_for @q, url: admin_users_path,
                        html: { method: :get, class: "pull-left form-inline" } do |f| %>
          <label>
            <strong>Filter by name or email:</strong>
            <%= f.text_field "name_or_email_cont" %>
          </label>
          <%= submit_tag "Search", class: "btn btn-primary" %>
        <% end %>
        <%= search_form_for @q, url: admin_users_path,
                        html: { method: :get, class: "pull-left form-inline" } do |f| %>
          <%= submit_tag "Clear", class: "btn offset" %>
        <% end %>
      </div>
    </div>
    <div class="span5">
      <div class="pull-right">
        <%= link_to "Create new user", new_user_invitation_path, class: "btn btn-success text-left" %>
        <%= link_to "Upload a batch of users", new_admin_batch_invitation_path, class: "btn text-right" %>
      </div>
    </div>
  </div>
  <% if current_user.has_role?("admin") %>
    <div class="row-fluid">
      <div class="span12">
        <div>
          <%= search_form_for @q, url: admin_users_path,
                          html: { method: :get, class: "pull-left form-inline" } do |f| %>
            <strong>Filter by application:</strong>
            <%= f.collection_select "permissions_application_id_eq", Doorkeeper::Application.all, :id, :name %>
            <%= f.hidden_field "permissions_signin_permission_not_eq", value: "0" %>
            <%= submit_tag "Search", class: "btn btn-primary" %>
          <% end %>
        </div>
      </div>
    </div>
  <% end %>

  <%= render partial: "pagination" %>

  <table class="table table-striped table-bordered">
    <thead>
      <tr>
        <th scope="col">Name and email</th>
        <th scope="col">Sign-in count</th>
        <th scope="col">Created</th>
        <th scope="col">Suspended?</th>
        <th scope="col">Actions</th>
      </tr>
    </thead>
    <tbody>
      <% @users.each do |user| %>
        <tr>
          <td class="email">
            <%= user.suspended? ? "<del>".html_safe : "" %>
              <%= link_to "#{user.name} <#{user.email}>", edit_admin_user_path(user) %>
            <%= user.suspended? ? "</del>".html_safe : "" %>
          </td>
          <td><%= user.sign_in_count %></td>
          <td><%= time_ago_in_words(user.created_at) %> ago</td>
          <td><%= user.suspended? ? "Yes" : "No" %></td>
          <td><%= link_to "Edit", edit_admin_user_path(user) %>
            <% if user.invited_but_not_accepted %>
              <%= form_tag resend_user_invitation_path(user) do %>
                <%= submit_tag "Resend signup email", :class => 'btn btn-primary' %>
              <% end %>
            <% end %>
            <% if user.access_locked? %>
              <%= form_tag unlock_admin_user_path(user) do %>
                <%= submit_tag "Unlock", :class => 'btn btn-danger' %>
              <% end %>
            <% end %>
          </td>
        </tr>
      <% end %>
    </tbody>
  </table>

  <%= render partial: "pagination" %>

</div>